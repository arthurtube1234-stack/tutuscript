--// Serviços
local MarketplaceService = game:GetService("MarketplaceService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Personagem
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

LocalPlayer.CharacterAdded:Connect(function(char)
    character = char
    humanoid = character:WaitForChild("Humanoid")
    rootPart = character:WaitForChild("HumanoidRootPart")
end)

-- Nome do jogo
local success, gameName = pcall(function()
    return MarketplaceService:GetProductInfo(game.PlaceId).Name
end)
if not success then
    gameName = "Jogo Desconhecido"
end

-- UI Fluent
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local Window = Fluent:CreateWindow({
    Title = gameName.." - Tutuz Script",
    SubTitle = "by tutu",
    TabWidth = 160,
    Size = UDim2.fromOffset(580,460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- Abas
local TabMain = Window:AddTab({Title = "Main", Icon = "gamepad-2"})
local TabScript = Window:AddTab({Title = "Scripts", Icon = "code"})

-- Variáveis
local flying, flySpeed, bodyVelocity, flyConnection = false, 50, nil, nil
local noclip, noclipConnection = false, nil
local infiniteJump = false
local espEnabled = false
local hitboxEnabled = false
local killAuraEnabled = false

local currentSpeed = humanoid.WalkSpeed
local currentJump = humanoid.JumpPower

-- ========== FUNÇÕES ==========

-- Fly
local function startFly()
    if flying then return end
    flying = true
    bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(1e5,1e5,1e5)
    bodyVelocity.Velocity = Vector3.new()
    bodyVelocity.Parent = rootPart

    flyConnection = RunService.Heartbeat:Connect(function()
        if not flying then return end
        local moveDir = Vector3.new()
        local cam = workspace.CurrentCamera
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir += cam.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir -= cam.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir -= cam.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir += cam.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir += Vector3.new(0,1,0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then moveDir -= Vector3.new(0,1,0) end
        bodyVelocity.Velocity = (moveDir.Magnitude > 0 and moveDir.Unit * flySpeed) or Vector3.new()
    end)
end

local function stopFly()
    flying = false
    if flyConnection then flyConnection:Disconnect() flyConnection=nil end
    if bodyVelocity then bodyVelocity:Destroy() bodyVelocity=nil end
end

-- NoClip
local function startNoClip()
    if noclip then return end
    noclip = true
    noclipConnection = RunService.Stepped:Connect(function()
        if character then
            for _, v in pairs(character:GetDescendants()) do
                if v:IsA("BasePart") then
                    v.CanCollide = false
                end
            end
        end
    end)
end

local function stopNoClip()
    noclip = false
    if noclipConnection then noclipConnection:Disconnect() noclipConnection=nil end
end

-- Infinite Jump
UserInputService.JumpRequest:Connect(function()
    if infiniteJump and humanoid then
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

-- TP Tool
local function createTPTool()
    local tool = Instance.new("Tool")
    tool.RequiresHandle = false
    tool.Name = "TP Tool"
    tool.Parent = LocalPlayer.Backpack
    tool.Activated:Connect(function()
        local mouse = LocalPlayer:GetMouse()
        if mouse and mouse.Hit then
            character:MoveTo(mouse.Hit.Position)
        end
    end)
end

-- ESP
local espObjects = {}
local function updateESP()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            if not espObjects[plr] then
                local box = Instance.new("BillboardGui")
                box.Size = UDim2.new(0,100,0,50)
                box.Adornee = plr.Character.HumanoidRootPart
                box.AlwaysOnTop = true
                local label = Instance.new("TextLabel")
                label.Size = UDim2.new(1,0,1,0)
                label.BackgroundTransparency = 1
                label.TextColor3 = Color3.new(1,0,0)
                label.TextStrokeTransparency = 0
                label.Text = plr.Name
                label.Parent = box
                box.Parent = game.CoreGui
                espObjects[plr] = box
            end
        end
    end
    -- Remove ESP de players mortos/desconectados
    for plr,obj in pairs(espObjects) do
        if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
            obj:Destroy()
            espObjects[plr] = nil
        end
    end
end

RunService.RenderStepped:Connect(function()
    if espEnabled then updateESP() end
end)

-- Hitbox Expander
local function updateHitbox()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Humanoid") then
            plr.Character.Humanoid.HipHeight = 0
            plr.Character.HumanoidRootPart.Size = (hitboxEnabled and Vector3.new(6,6,6)) or Vector3.new(2,2,1)
        end
    end
end

RunService.RenderStepped:Connect(updateHitbox)

-- Kill Aura (ataca players próximos)
local function killAura()
    if not killAuraEnabled then return end
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Humanoid") and plr.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = plr.Character.HumanoidRootPart
            if (rootPart.Position - hrp.Position).Magnitude <= 10 then
                -- Só funciona se tiver espada/gear na mão
                local tool = character:FindFirstChildOfClass("Tool")
                if tool then
                    tool:Activate()
                end
            end
        end
    end
end
RunService.RenderStepped:Connect(killAura)

-- ========== UI ==========

-- MAIN
TabMain:AddButton({
    Title = "Fly Mobile",
    Description = "Executa script de voo para mobile",
    Callback = function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))()
    end
})

TabMain:AddToggle("FlyPCToggle",{Title="Fly PC",Description="Ativa/desativa voo no PC",Default=false,Callback=function(state) if state then startFly() else stopFly() end end})
TabMain:AddSlider("SpeedSlider",{Title="Velocidade",Description="Modificar a velocidade",Default=humanoid.WalkSpeed,Min=16,Max=200,Rounding=1,Callback=function(Value) currentSpeed=Value humanoid.WalkSpeed=currentSpeed end})
TabMain:AddSlider("JumpSlider",{Title="Força do pulo",Description="Modificar o pulo",Default=humanoid.JumpPower,Min=50,Max=300,Rounding=1,Callback=function(Value) currentJump=Value humanoid.JumpPower=currentJump end})
TabMain:AddToggle("NoClipToggle",{Title="NoClip",Description="Atravessar paredes",Default=false,Callback=function(state) if state then startNoClip() else stopNoClip() end end})
TabMain:AddToggle("InfJumpToggle",{Title="Infinite Jump",Description="Pular infinitamente",Default=false,Callback=function(state) infiniteJump=state end})
TabMain:AddButton({Title="TP Tool",Description="Ferramenta para teleportar ao clicar",Callback=createTPTool})
TabMain:AddToggle("ESP",{Title="ESP",Description="Ativa/Desativa ESP",Default=false,Callback=function(state) espEnabled=state end})
TabMain:AddToggle("Hitbox",{Title="Hitbox Expander",Description="Ativa/Desativa Hitbox",Default=false,Callback=function(state) hitboxEnabled=state end})
TabMain:AddToggle("KillAura",{Title="Kill Aura",Description="Ativa/Desativa Kill Aura",Default=false,Callback=function(state) killAuraEnabled=state end})

-- SCRIPTS
TabScript:AddButton({
    Title="Infinite Yield",
    Description="Executa Infinite Yield",
    Callback=function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))()
    end
})
